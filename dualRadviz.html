<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>RadViz</title>

    </head>
    <body>
        <div id="chart"></div>
        <div id="attrCircles"></div>
        <div id="instanceCircles"></div>

        <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script src="d3.slider.js"></script>
        <script type="text/javascript" src="polybrush.js"></script>
        <link rel="stylesheet" href="d3.slider.css" />


        <h3> <span id="contribution">Class: 50% / Attributes: 50%</span></h3>

        <div id="classContribSlider"></div>

        <style>
            body {
                font-family: Verdana,Arial,sans-serif;
            }
            #chart {
                height: 620px;
                margin: 0 auto;
                position: relative;
                width: 1000px;
            }

            .tooltip {
                background: #eee;
                box-shadow: 0 0 5px #999999;
                color: #333;
                display: none;
                opacity: 0.9;
                font-size: 12px;
                left: 130px;
                padding: 10px;
                position: absolute;
                text-align: left;
                top: 95px;
                width: 200px;
                z-index: 10;
            }

            #classContribSlider {
                height: 10px;
                width: 300px;
            }

            .brush .extent {
                stroke: #000;
                stroke-width: 1.5px;
                fill: #000;
                fill-opacity: 0.1;
            }

            .legendRect {
                x: 5px;
                width: 20px;
                height: 20px;
                rx: 5px;
                ry: 5px;
            }

            .legendText {
                width: 80px;
                height: 20px;
                //text-align: left;
                font-size: 12px;
            }

            circle.selected {
                //fill: red;
                stroke: darkred;
                stroke-width: 3;
            }

        </style>

        <script>
            var fileName;
            var svgWidth = 1000;
            var svgHeight = 620;
            var color = d3.scale.category10();

            var useClass = true;

            var pi = Math.PI;
            var twoPi = pi * 2;
            var arc;

            var shitfPressed = false;

            //fileName = "iris madeup.csv";
            fileName = "iris naive bayes.csv";
            //fileName = "iris nn.csv";

            function Da(){
                this.x;
                this.y;
                this.scaledX;
                this.scaledY;
                this.labelX;
                this.labelY;
                this.scale;
                this.key;
                this.arc;
                this.color;
                this.r;

                this.updateBasedOnNewArc = function(rv) {
                    //console.log(super);
                    var arc = this.arc + rv.arc;

                    this.x = rv.x + Math.cos(arc) * (rv.r + this.r/2);
                    this.y = rv.y + Math.sin(arc) * -(rv.r + this.r/2);

                    this.labelX = rv.x +  Math.cos(arc) * (rv.r + this.r);
                    this.labelY = (rv.y - (Math.sin(arc) * (rv.r + this.r))) - 15;

                    //*/
                    this.scaledX = rv.x + Math.cos(arc) * (rv.getScaledR() - this.r/2);
                    this.scaledY = rv.y + (Math.sin(arc) * -(rv.getScaledR() - this.r/2));

                }

                this.getInfo = function(){
                    return "key: " + this.key + "\n" +
                            "pos: " + [this.x, this.y] + "\n" +
                            "labelPos: " + [this.labelX, this.labelY] + "\n"; }
            }

            function RvCircle(){
                this.path;
                this.x;
                this.y;
                this.r;
                this.instanceRadius;
                this.thickness;
                this.color;
                this.da = [];
                this.daGroup;
                this.daLabelGroup;
                this.contribution;
                this.dragging = false;
                this. arc = 0;
                this.createPath = function() {
                    arc = d3.svg.arc()
                            .innerRadius(this.r)
                            .outerRadius(this.r + this.thickness)
                            .startAngle(0)
                            .endAngle(twoPi);

                    this.path = svgContainer.append("path")
                            .attr("d", arc)
                            .attr("fill", this.color)
                            .attr("transform","translate(" + this.x + ", " + this.y + ")");
                }

                this.initializeDaInfo = function(headers, data) {
                    var unscaledX;
                    var unscaledY;
                    var daCount = headers.length;
                    for (var i = 0; i < daCount; i++) {
                        var thisDa = new Da();
                        thisDa.arc = i/daCount * twoPi;

                        unscaledX = Math.cos(thisDa.arc);
                        unscaledY = -Math.sin(thisDa.arc);

                        thisDa.key = headers[i].key.toString();
                        thisDa.r = 7;

                        thisDa.x = this.x + unscaledX * (this.r + thisDa.r/2);
                        thisDa.y = this.y + unscaledY * (this.r + thisDa.r/2);

                        thisDa.labelX = this.x + unscaledX * (this.r + thisDa.r);
                        thisDa.labelY = (this.y + unscaledY * (this.r + thisDa.r)) - 15;

                        //console.log(this.instanceRadius);

                        if (this.instanceRadius !== undefined) {
                            thisDa.scaledX = this.x + unscaledX * (this.instanceRadius - thisDa.r/2);
                            thisDa.scaledY = this.y + unscaledY * (this.instanceRadius - thisDa.r/2);
                        }
                        else {
                            thisDa.scaledX = this.x + unscaledX * (this.r - thisDa.r/2);
                            thisDa.scaledY = this.y + unscaledY * (this.r - thisDa.r/2);
                        }

                        thisDa.color = "white";

                        thisDa.scale = d3.scale.linear()
                                .domain([
                                    d3.min(data,function(d) {return +d[thisDa.key]}),
                                    d3.max(data,function(d) {return +d[thisDa.key]})
                                ])
                                .range([0, 1]);

                        //console.log(thisDa.getInfo());
                        this.da[i] = thisDa;

                    }
                }

                this.getScaledR = function(){

                    if (this.instanceRadius !== undefined) {

                        return this.instanceRadius;
                    }

                    return this.r;
                }
                this.createDaGroup = function() {
                    this.daGroup = svgContainer.append("g");
                    this.daGroup.selectAll("circle")
                            .data(this.da)
                            .enter()
                            .append("circle")
                            .attr("cx", function(d){ return d.x;})
                            .attr("cy", function(d){ return d.y;})
                            .attr("r", function(d){ return d.r;})
                            .attr("fill",function(d){ return d.color;})
                            .attr("stroke","black")
                            .attr("stroke-width", 2);

                    this.daLabelGroup = svgContainer.append("g");
                    this.daLabelGroup.selectAll("text")
                            .data(this.da)
                            .enter()
                            .append("text")
                            .attr("x", function(d){ return d.labelX;})
                            .attr("y", function(d){ return d.labelY;})
                            .text(function(d){ return d.key;})
                            .attr("fill", "black")
                            .style("font-family", "verdana")
                            .style("font-size", 12)
                            .attr("text-anchor", "middle")
                    ;
                }

                this.initializeInstGroup = function(data) {
                    this.instGroup = svgContainer.append("g");
                    this.instGroup.selectAll("circle")
                        .data(data)
                        .enter()
                        .append("circle")
                        .attr("cx", this.x)
                        .attr("cy", this.y)
                        .attr("r", 1)
                        //.attr("stroke", "black")
                        .attr("fill",function(d){return color(d.class);});
                }

                this.updateInst = function(instantly) {
                    var selection;

                    if (!instantly) {
                        selection = this.instGroup.selectAll("circle").transition().duration(1000);
                    }
                    else {
                        selection = this.instGroup.selectAll("circle");
                    }

                    selection
                            .attr("cx", function(d, i){
                                return getInstancePosition(d)[0];
                            })
                            .attr("cy", function(d, i){return getInstancePosition(d)[1];
                            })
                            .attr("opacity",.7)
                            .attr("r", 3.5)
                            //.style("opacity",function(d){return o(+d.sepal_width);});
                            .attr("fill",function(d){return color(d.class);});
                }

            }

            function funcTest(i) {
                console.log(" instancia na funcTest " + i);
                return i;
            }

            // SETUP BRUSH
            function setupBrush() {
                var brush = d3.svg.polybrush()

                        .x(d3.scale.linear().range([0, svgWidth]))
                        .y(d3.scale.linear().range([0, svgHeight]))

                //*
                        .on("brush", function() {
                            // set the 'selected' class for the circle

                            rvInst.instGroup.selectAll("circle").classed("selected", function(d) {

                                var x = d3.select(this).attr("cx");
                                var y = d3.select(this).attr("cy");

                                if (brush.isWithinExtent(x, y)) {
                                    d3.select(this).classed("selected", true);

                                    return true;
                                } else {
                                    d3.select(this).classed("selected", false);

                                    return false;
                                }
                            });
                        });
                        //*/
//
                svgContainer.append("g")
                        .attr("class", "brush")
                        .call(brush);

            }


            getInstancePosition = function(d) {

                var somaX = 0;
                var somaY = 0;
                var somaDenominador = 0;
///*
                var rv = rvInst;
                var da = rv.da;

                for (var i = 0; i < da.length; i++) {
                    var val = da[i].scale(+d[da[i].key]);
                    //var val = +d[da[i].key];
                    //console.log(val);
                    somaX = somaX + da[i].x * val * rv.contribution;
                    somaY = somaY + da[i].y * val * rv.contribution;
                    somaDenominador = somaDenominador + val * rv.contribution;
                }
//*/
                var rv = rvClass;
                var da = rv.da;

                for (var i = 0; i < da.length; i++) {
                    var val = da[i].scale(+d[da[i].key]);
                    //var val = +d[da[i].key];

                    somaX = somaX + da[i].scaledX * val * rv.contribution;
                    somaY = somaY + da[i].scaledY * val * rv.contribution;
                    somaDenominador = somaDenominador + val * rv.contribution;
                }

                if (somaDenominador == 0) {

                   console.log("denom: " + somaDenominador + " ... " + [somaX / somaDenominador, somaY / somaDenominador])
                }
                return [somaX/somaDenominador, somaY/somaDenominador];
            }

            d3.select("body")
                    .on("keydown", function() {
                        shitfPressed = d3.event.shiftKey;
                        if(d3.event.char == "c".charCodeAt(0)){
                            rvInst.instGroup.selectAll(".selected").classed("selected", false);
                        }
                    })
                    .on("keyup", function() {
                        shitfPressed = d3.event.shiftKey;
                    })


            rvInst = new RvCircle();
            rvInst.x = svgWidth/2;
            rvInst.y = svgHeight/2;
            rvInst.r = 210;
            rvInst.color = "mediumSlateBlue";
            rvInst.thickness = 4;
            rvInst.contribution = 1;
//            rvInst.arc = pi/4;

            rvClass = new RvCircle();
            rvClass.x = svgWidth/2;
            rvClass.y = svgHeight/2;
            rvClass.r = 270;
            rvClass.instanceRadius = rvInst.r;
            rvClass.color = "coral";
            rvClass.thickness = 4;
            rvClass.contribution = 1;

            var svgContainer = d3.select("#chart")
                    .append("svg:svg")
                    .attr("width", svgWidth)
                    .attr("height", svgHeight)
                    //.style("border", "1px solid black")
                    .attr("transform", "translate(0,0)");

            rvInst.createPath();

            //d3.csv("iris svm wo true class.csv",function(csv) {
            d3.csv(fileName,function(csv) {
                var daPositions = [];
                var labelPositions = [];

                var headers = d3.entries(csv[0]);
                //headers = headers.splice(0, 4);
                var classIndex = headers.indexOf("class");
                for (var i = 0; i < headers.length; i++) {
                    if (headers[i].key.toString() == "class") {
                        classIndex = i;
                        break;
                    }
                }

                setupBrush();

                headers = headers.slice(0, classIndex);
                rvInst.initializeDaInfo(headers, csv);
                rvInst.createDaGroup();
                rvInst.initializeInstGroup(csv);

                rvClass.createPath();
                var headersClass = d3.entries(csv[0]);
                headersClass = headersClass.slice(classIndex+1, headersClass.length-1);
                var classNames = []
                rvClass.initializeDaInfo(headersClass, csv);
                for(var i = 0; i < rvClass.da.length; i++) {
                    var keyName = rvClass.da[i].key;
                    keyName = keyName.replace("confidence(", "").replace(")", "");
                    //console.log(keyName);
                    classNames[i] = keyName;
                    rvClass.da[i].color = color(keyName);
                }
                rvClass.createDaGroup();

                rvInst.updateInst(false);

                var tooltip = d3.select("#chart")
                        .append("div")
                        .attr("class", "tooltip");

                tooltip.append("div")
                        .attr("class", "label");

                getInstanceStr = function(d) {
                    var str = "";
                    for (var i = 0; i < headers.length; i++){
                        str = str + "<p>" + headers[i].key + ": " + d[headers[i].key] + "</p>"
                    }
                    for (var i = 0; i < headersClass.length; i++){
                        str = str + "<p>" + headersClass[i].key + ": " + Math.round(d[headersClass[i].key]*100)/100 + "</p>"
                    }
                    return str;
                };


                rvInst.instGroup.selectAll("circle").on("mouseover", function(d) {

                    tooltip.html(getInstanceStr(d));

                    var x = parseInt(d3.select(this).attr("cx"));
                    var y = parseInt(d3.select(this).attr("cy"));

                    tooltip.style("top", (y + 10) + "px")
                            .style("left", (x + 10) + "px");

                    tooltip.style("display", "block");
                    tooltip.transition().duration(150).style("opacity",.9)
                    d3.select(this).attr("stroke","black");
                    d3.select(this).attr("stroke-width", 2);
                    //console.log("mouse over...");
                });

                rvInst.instGroup.selectAll("circle").on("mouseout", function() {

                    d3.select(this).attr("stroke-width", 0);
                    tooltip.transition().duration(150).style("opacity", 0);

                    //console.log("mouse out...");
                });


                rvInst.instGroup.selectAll("circle").on("mousemove", function(d) {
                    var x = parseInt(d3.select(this).attr("cx"));
                    var y = parseInt(d3.select(this).attr("cy"));

                    tooltip.style("top", (y + 10) + "px")
                            .style("left", (x + 10) + "px");

                    //console.log("mouse move");
                });


                var dragInst = d3.behavior.drag()
                        .origin(function(d) { return d; })
                        //.on("dragstart", dragstarted)
                        .on("drag", function (d, i) {
                            createDragBehaviour(rvInst, this, i);
                        });

                var dragClass = d3.behavior.drag()
                        .origin(function(d) { return d; })
                        //.on("dragstart", dragstarted)
                        .on("drag", function (d, i) {
                            createDragBehaviour(rvClass, this, i);
                        });

                var dragRvInst = d3.behavior.drag()
                        //.origin(function(d) { return d; })
                        .on("drag", function () {
                            //d3.event.delta
                            var rv = {}
                            rv = rvInst;

                            var da = rv.da;
//*
                            var x = (d3.event.x - rv.x);
                            var y = (d3.event.y - rv.y);

                            var mag = Math.sqrt(x*x + y*y);
                            x = x/mag;
                            y = y/mag;


                            if(!rv.dragging) {

                                rv.dragging = true;
                                dragStartArc = Math.atan2(x,y) - pi/2;
                                rvOrigArc = rv.arc;
                                //console.log("x: " + x + "\n y: " + y);
                                //console.log("start arc: " + dragStartArc*180/pi);
                                //console.log("orig arc: " + rvOrigArc*180/pi);
                                //console.log("...");
                            }
                            else {

                                var arcIncrement =  (Math.atan2(x,y) - pi/2) - dragStartArc;
                                //console.log("diff: " + arcIncrement*180/pi);
                                //console.log("orig arc: " + rvOrigArc*180/pi);

                                rv.arc = rvOrigArc +  arcIncrement;

                                for(var i = 0; i < da.length; i++) {

                                    da[i].updateBasedOnNewArc(rv);

                                }

                                rvInst.updateInst(true);

                                rv.daGroup.selectAll("circle")
                                        .attr("cx", function(d, i) {return da[i].x;})
                                        .attr("cy", function(d, i) {return da[i].y;});

                                rv.daLabelGroup.selectAll("text")
                                        .attr("x", function(d, i) {return da[i].labelX;})
                                        .attr("y", function(d, i) {return da[i].labelY;});



//*/
                            }
                        });

                createDragBehaviour = function(rv, circle, i) {

                    var da = rv.da;

                    var x = da[i].x + d3.event.dx;
                    var y = da[i].y + d3.event.dy;

                    var xFromCenter = x - rv.x;
                    var yFromCenter = y - rv.y;

                    var mag = Math.sqrt(xFromCenter*xFromCenter +
                            yFromCenter * yFromCenter);

                    var arcDiff = (Math.atan2(xFromCenter/mag,yFromCenter/mag) - pi/2) - da[i].arc;

                    //da[i].arc = Math.atan2(xFromCenter/mag,yFromCenter/mag) - pi/2;
                    if(shitfPressed) {
                        da[i].arc += arcDiff;
                        da[i].updateBasedOnNewArc(rv);

                        d3.select(circle)
                                .attr("cx", da[i].x)
                                .attr("cy", da[i].y);

                    }

                    else {
//*
                        for(var daCount = 0; daCount < da.length; daCount++) {
                            da[daCount].arc += arcDiff;
                            da[daCount].updateBasedOnNewArc(rv);

                        }

                        rv.daGroup.selectAll("circle")
                                .attr("cx", function(d, i) {return da[i].x;})
                                .attr("cy", function(d, i) {return da[i].y;});
 //*/
                    }


                    rv.daLabelGroup.selectAll("text")
                            .attr("x", function(d, i) {return da[i].labelX;})
                            .attr("y", function(d, i) {return da[i].labelY;});

                    rvInst.updateInst(true);

                }

                rvInst.daGroup.selectAll("circle").call(dragInst);
                rvClass.daGroup.selectAll("circle").call(dragClass);

                rvInst.daLabelGroup.selectAll("circle").call(dragInst);

                //console.log(classNames);
                svgContainer.selectAll("legendRect")
                        .data(classNames)
                        .enter()
                        .append("rect")
                        .attr("class", "legendRect")
                        .attr("y", function(d, i) {
                            return 30 + 30*i
                        })
                        .style("fill", function(d){return color(d)});

                svgContainer.selectAll("legendText")
                        .data(classNames)
                        .enter()
                        .append("text")
                        .attr("class", "legendText")
                        .attr("x", 30)
                        .attr("y", function(d, i) {
                            return 45 + 30*i
                        })
                        .text(function(d){ return d;})

                var axis = d3.svg.axis().orient("top").ticks(10);

                d3.select("#classContribSlider").call(d3.slider().min(-100).max(100).value(0.00000001)
                        .on("slide", function(evt, value) {
                            rvClass.contribution = 1 - value/100;
                            rvInst.contribution = 1 + value/100;

                            var cContr = rvClass.contribution / (rvClass.contribution + rvInst.contribution);
                            var aContr = rvInst.contribution / (rvClass.contribution + rvInst.contribution);

                            d3.select("#contribution")
                                    .text("Class: " + Math.round(cContr*100) + "% / Attributes: " + Math.round(aContr*100) + "%");

                            rvInst.updateInst(true);
                        }));


            });

        </script>
    </body>
</html>
